{% extends 'base.html' %}
{% load static %}

{% block title %}{{ medicine.name }} - MedShare{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
{% endblock %}

{% block content %}
<div class="container py-4">
    <a href="{% url 'search_medicines' %}" style="color: var(--primary); text-decoration: none; margin-bottom: 20px; display: inline-block;">
        <i class="fas fa-arrow-left"></i> Back to Search
    </a>

    <div class="card app-card">
        <div class="detail-grid">
            <!-- Medicine Image -->
            <div>
                {% if medicine.image %}
                    <img src="{{ medicine.image.url }}" alt="{{ medicine.name }}" class="img-fluid rounded detail-image">
                {% else %}
                    <div style="width: 100%; height: 400px; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                        <i class="fas fa-pills" style="font-size: 100px;"></i>
                    </div>
                {% endif %}
            </div>

            <!-- Medicine Details -->
            <div>
                <h1 style="color: var(--primary); margin-bottom: 15px;">{{ medicine.name }}</h1>

                <!-- Status Badge -->
                <div style="margin-bottom: 20px;">
                    <span class="badge {% if medicine.status == 'available' %}badge-success{% elif medicine.status == 'donated' %}badge-warning{% else %}badge-danger{% endif %}">
                        <i class="fas fa-info-circle"></i> {{ medicine.get_status_display }}
                    </span>
                </div>

                <!-- Rating -->
                {% if avg_rating %}
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="color: #ffc107; font-size: 18px;">
                            {% for i in "12345" %}
                                {% if forloop.counter <= avg_rating %}★{% else %}☆{% endif %}
                            {% endfor %}
                        </div>
                        <span style="color: #666;">{{ avg_rating|floatformat:1 }}/5 ({{ ratings|length }} reviews)</span>
                    </div>
                </div>
                {% endif %}

                <!-- Key Details -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <p style="color: #999; font-size: 12px; margin-bottom: 5px;">QUANTITY</p>
                            <p style="color: var(--dark); font-size: 18px; font-weight: bold;">{{ medicine.quantity }} {{ medicine.unit }}</p>
                        </div>
                        <div>
                            <p style="color: #999; font-size: 12px; margin-bottom: 5px;">EXPIRY DATE</p>
                            <p style="color: var(--dark); font-size: 18px; font-weight: bold;">{{ medicine.expiry_date|date:"M d, Y" }}</p>
                            {% if days_left < 0 %}
                                <span class="badge badge-danger"><i class="fas fa-exclamation"></i> Expired {{ days_left|add:"0"|stringformat:".0f" }} days ago</span>
                            {% elif days_left <= 30 %}
                                <span class="badge badge-warning"><i class="fas fa-clock"></i> Expires in {{ days_left }} days</span>
                            {% else %}
                                <span class="badge badge-success"><i class="fas fa-check"></i> {{ days_left }} days left</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Description -->
                {% if medicine.description %}
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--dark); margin-bottom: 10px;">Description</h3>
                    <p style="color: #666; line-height: 1.6;">{{ medicine.description }}</p>
                </div>
                {% endif %}

                <!-- Additional Info -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark); margin-bottom: 15px;">Additional Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                        {% if medicine.manufacture_date %}
                        <div>
                            <p style="color: #999; margin-bottom: 3px;">Manufacture Date</p>
                            <p style="color: var(--dark);">{{ medicine.manufacture_date|date:"M d, Y" }}</p>
                        </div>
                        {% endif %}
                        {% if medicine.batch_number %}
                        <div>
                            <p style="color: #999; margin-bottom: 3px;">Batch Number</p>
                            <p style="color: var(--dark);">{{ medicine.batch_number }}</p>
                        </div>
                        {% endif %}
                        {% if medicine.storage_condition %}
                        <div>
                            <p style="color: #999; margin-bottom: 3px;">Storage Condition</p>
                            <p style="color: var(--dark);">{{ medicine.storage_condition }}</p>
                        </div>
                        {% endif %}
                        {% if medicine.location_name %}
                        <div>
                            <p style="color: #999; margin-bottom: 3px;">Location</p>
                            <p style="color: var(--dark);"><i class="fas fa-map-marker-alt"></i> {{ medicine.location_name }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if medicine.latitude and medicine.longitude %}
                <div class="card app-card" style="padding: 16px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark); margin-bottom: 12px;"><i class="fas fa-map"></i> Pickup Location</h3>
                    <div
                        id="medicine-map"
                        data-lat="{{ medicine.latitude }}"
                        data-lng="{{ medicine.longitude }}"
                        data-label="{{ medicine.location_name|default:'Pickup location'|escape }}"
                        style="height: 240px; border-radius: 12px;"
                    ></div>
                    <p style="color: #6b7280; font-size: 12px; margin: 10px 0 0 0;">
                        Coordinates: {{ medicine.latitude }}, {{ medicine.longitude }}
                    </p>
                </div>
                {% endif %}

                <!-- Donor Info (Hide Email/Phone - Privacy) -->
                <div style="background: linear-gradient(135deg, rgba(46,204,113,0.1) 0%, rgba(52,73,94,0.1) 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: var(--dark); margin-bottom: 15px;">Donor Information</h3>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <p style="color: var(--dark); font-weight: bold; margin-bottom: 3px;">Donor ({{ medicine.donor.profile.get_role_display }})</p>
                            {% if medicine.donor.profile.organization_name %}
                            <p style="color: #666; font-size: 14px; margin-bottom: 3px;">{{ medicine.donor.profile.organization_name }}</p>
                            {% endif %}
                            <p style="color: #999; font-size: 12px;">
                                <i class="fas fa-lock"></i> Contact via MedShare messaging for privacy
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Contact Donor Button -->
                {% if user.is_authenticated and medicine.status == "available" %}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <a href="{% url 'start_conversation' medicine.id %}" class="btn-primary" style="padding: 14px; text-align: center; font-size: 14px;">
                        <i class="fas fa-comments"></i> Contact Donor (Chat)
                    </a>
                    <a href="{% url 'request_medicine' medicine.id %}" class="btn-secondary" style="padding: 14px; text-align: center; font-size: 14px;">
                        <i class="fas fa-hand-paper"></i> Request Medicine
                    </a>
                </div>
                {% elif not user.is_authenticated %}
                <a href="{% url 'login' %}" class="btn-primary" style="width: 100%; padding: 14px; text-align: center; font-size: 16px; margin-bottom: 15px;">
                    <i class="fas fa-sign-in-alt"></i> Login to Request
                </a>
                {% elif medicine.status != "available" %}
                <button class="btn-secondary" disabled style="width: 100%; padding: 14px; text-align: center; font-size: 16px; opacity: 0.5;">
                    <i class="fas fa-lock"></i> Not Available
                </button>
                {% endif %}

                <!-- Rate Button -->
                {% if user.is_authenticated %}
                <a href="{% url 'rate_medicine' medicine.id %}" class="btn-secondary" style="width: 100%; padding: 14px; text-align: center; font-size: 16px;">
                    <i class="fas fa-star"></i> Rate This Medicine
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    {% if ratings %}
    <div class="card app-card" style="margin-top: 40px;">
        <div class="card-header">
            <h2 class="card-title"><i class="fas fa-comments"></i> Reviews ({{ ratings|length }})</h2>
        </div>

        {% for rating in ratings %}
        <div style="border-bottom: 1px solid #eee; padding: 20px 0; display: flex; gap: 20px;">
            {% if rating.user.profile.profile_picture %}
                <img src="{{ rating.user.profile.profile_picture.url }}" alt="{{ rating.user.username }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
            {% else %}
                <div style="width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                    <i class="fas fa-user"></i>
                </div>
            {% endif %}

            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <p style="color: var(--dark); font-weight: bold; margin: 0;">{{ rating.user.get_full_name|default:rating.user.username }}</p>
                    <p style="color: #999; font-size: 12px; margin: 0;">{{ rating.created_at|date:"M d, Y" }}</p>
                </div>

                <div style="color: #ffc107; margin-bottom: 8px;">
                    {% for i in "12345" %}
                        {% if forloop.counter <= rating.rating %}★{% else %}☆{% endif %}
                    {% endfor %}
                    <span style="color: var(--dark);">{{ rating.rating }}/5</span>
                </div>

                {% if rating.review %}
                <p style="color: #666; margin: 0;">{{ rating.review }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
    (function () {
        const el = document.getElementById('medicine-map');
        if (!el) return;

        const lat = parseFloat(el.dataset.lat || '');
        const lng = parseFloat(el.dataset.lng || '');
        if (Number.isNaN(lat) || Number.isNaN(lng)) return;

        const map = L.map('medicine-map', { scrollWheelZoom: false }).setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        const label = el.dataset.label || 'Pickup location';
        L.marker([lat, lng]).addTo(map).bindPopup(label).openPopup();
    })();
</script>
{% endblock %}
